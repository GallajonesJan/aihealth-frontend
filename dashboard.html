<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | AI Health Monitor</title>

  <link rel="stylesheet" href="css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script>
    // Apply dark mode immediately before page renders
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>

<body>
  <!-- Back Button -->
  <button class="back-btn" onclick="window.location.href='signin.html'">â† Back</button>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html" class="active">
  <img src="images/dashboard.png" class="nav-icon"> Dashboard
</a>
        <a href="./healthlogs.html">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="./device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">ğŸ¤– AlertoBot</a>
        <a href="#" id="logout-btn">ğŸšª Logout</a>
      </nav>
    </aside>

    <!-- Main Dashboard -->
    <main class="main-content">
      <header class="dashboard-header">
        <h1 id="welcome-text">Welcome, User ğŸ‘‹</h1>
        <p>Here's your latest health summary</p>
      </header>

      <!-- Health Cards -->  
      <section class="cards">
        <div class="card">
          <h3>â¤ï¸ Heart Rate</h3>
          <p class="value">78 <span>BPM</span></p>
        </div>
        <div class="card">
          <h3>ğŸ’§ Glucose Level</h3>
          <p class="value">95 <span>mg/dL</span></p>
        </div>
        <div class="card">
          <h3>ğŸŒ¬ï¸ SpOâ‚‚</h3>
          <p class="value">98<span>%</span></p>
        </div>
        <div class="card">
          <h3>ğŸŒ¡ï¸ Body Temp</h3>
          <p class="value">36.6<span>Â°C</span></p>
        </div>
      </section>

      <!-- Chart Section -->
      <section class="chart-section">
        <h2>ğŸ“ˆ Weekly Health Trend</h2>
        <div class="chart-container">
          <canvas id="healthChart"></canvas>
        </div>
      </section>
    </main>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api.js"></script>

  <script>
    // Apply saved theme on page load
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }

    // Static weekly data
    const labels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    const data = {
      labels: labels,
      datasets: [
        {
          label: "Heart Rate (BPM)",
          data: [78, 80, 76, 82, 79, 77, 81],
          borderColor: "#ff4d6d",
          backgroundColor: "rgba(255, 77, 109, 0.2)",
          tension: 0.4,
          fill: false,
        },
        {
          label: "Glucose (mg/dL)",
          data: [95, 97, 94, 96, 99, 93, 98],
          borderColor: "#00e5ff",
          backgroundColor: "rgba(0, 229, 255, 0.2)",
          tension: 0.4,
          fill: false,
        },
        {
          label: "SpOâ‚‚ (%)",
          data: [98, 97, 99, 98, 98, 97, 99],
          borderColor: "#00c853",
          backgroundColor: "rgba(0, 200, 83, 0.2)",
          tension: 0.4,
          fill: false,
        },
        {
          label: "Temperature (Â°C)",
          data: [36.6, 36.5, 36.7, 36.8, 36.5, 36.6, 36.7],
          borderColor: "#ffd54f",
          backgroundColor: "rgba(255, 213, 79, 0.2)",
          tension: 0.4,
          fill: false,
        },
      ],
    };

    // Detect dark mode from localStorage
    const isDarkMode = localStorage.getItem("theme") === "dark";

    const chartOptions = {
      responsive: true,
      interaction: {
        mode: "index",
        intersect: false,
      },
      plugins: {
        legend: {
          labels: {
            color: isDarkMode ? "#ffffff" : "#000000",
            font: { size: 13 },
          },
        },
        tooltip: {
          callbacks: {
            // ğŸ§  Add custom units per dataset
            label: function (context) {
              let label = context.dataset.label || "";
              let value = context.parsed.y;
              if (label.includes("Heart Rate")) return `${label}: ${value} BPM`;
              if (label.includes("Glucose")) return `${label}: ${value} mg/dL`;
              if (label.includes("SpOâ‚‚")) return `${label}: ${value}%`;
              if (label.includes("Temperature")) return `${label}: ${value}Â°C`;
              return `${label}: ${value}`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: {
            color: isDarkMode ? "#ffffff" : "#000000",
          },
          grid: {
            color: isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)",
          },
        },
        y: {
          ticks: {
            color: isDarkMode ? "#ffffff" : "#000000",
          },
          grid: {
            color: isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)",
          },
        },
      },
      animation: {
        duration: 1200,
        easing: "easeInOutQuart",
      },
    };

    const ctx = document.getElementById("healthChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: data,
      options: chartOptions,
    });

    if (!localStorage.getItem("access_token")) {
      window.location.href = "signin.html"; // force login
    }

document.getElementById("logout-btn").addEventListener("click", function (e) {
  e.preventDefault();
  localStorage.removeItem("access_token");
  localStorage.removeItem("username");
  localStorage.removeItem("age");
  window.location.href = "signin.html";
});




document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("access_token");
    const user_id = localStorage.getItem("user_id");

    if (!token || !user_id) return;

    const res = await fetch(`http://192.168.100.13:5000/user/${user_id}`, {
        method: "GET",
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await res.json();
    console.log("USER INFO:", data);

    // update header text
    if (data.fullname) {
        document.getElementById("welcome-text").innerText =
            "Welcome, " + data.fullname.split(" ")[0] + " ğŸ‘‹";
    }
});

  </script>
  <script src="js/device.js"></script>
</body>
</html>